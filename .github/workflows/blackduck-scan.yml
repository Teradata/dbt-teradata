name: BlackDuck Scan

on:
  workflow_dispatch:
  schedule:
     - cron:  '45 7 * * 5'

jobs:
  blackduck-scan:
    if: github.repository == 'DeveloperTools/dbt-teradata'
    runs-on: [self-hosted]
    defaults:
      run:
        shell: bash
    name: BlackDuck Scan
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
      - name: Clone dbt Teradata Adapter
        run: |
          rm -rf /dbt
          mkdir /dbt
          cd /dbt; git clone https://${{ secrets.GH_TOKEN }}@github.td.teradata.com/DeveloperTools/dbt-teradata.git
      - name: Build dbt teradata package
        run: |
          cd /dbt/dbt-teradata; rm -fr dist/*; python3 setup.py sdist bdist_wheel
      - name: BlackDuck Configure
        run: |
          rm -rf /bd_scan
          mkdir  /bd_scan
          cd /bd_scan
          python3 -m venv env

      - name: Run BlackDuck Scan
        run: |
          cd /bd_scan
          . ./env/bin/activate
          pip3 install /dbt/dbt-teradata/dist/*.gz
          pip3 freeze > requirements.txt
          bash <(curl -s -L https://detect.synopsys.com/detect7.sh) \
          --blackduck.url=https://bdhub.td.teradata.com \
          --blackduck.always.trust.cert=true \
          --blackduck.api.token=${{ secrets.BLACKDUCK_TOKEN }} \
          --detect.project.name=JUPYTERUX_dbt \
          --detect.project.version.name=development \
          --detect.code.location.name=JUPYTERUX_dbt-development \
          --detect.bom.aggregate.name=JUPYTERUX_dbt-develop \
          --detect.cleanup=false \
          --detect.output.path=/dbt \
          --blackduck.timeout=1500 \
          --detect.pip.only.project.tree=true \
          --detect.pip.project.version.name=1.0.0a0 \
          --detect.pip.project.name=dbt-teradata \
          --detect.source.path=env/lib/python3.10/site-packages/dbt_teradata-1.0.0a0.egg-info \
          --detect.pip.requirements.path=requirements.txt
